<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Safarié˜²ç¼“å­˜/å¼ºåˆ¶é‡è½½æ ‡ç­¾ -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="color-scheme" content="light only">
    <title>WordRunMaster â€” é…ç½®ä¸­å¿ƒ v3.5.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        /* â”€â”€ Design Tokens (Light Theme) â”€â”€ */
        :root {
            --bg-body: #F4F6F9;
            --bg-panel: #FFFFFF;
            --bg-section: #F0F2F5;
            --bg-input: #FFFFFF;
            --bg-input-focus: #FFFFFF;
            --border: #E0E4EA;
            --border-active: #4A9EEB;
            --accent: #4A9EEB;
            --accent-light: #EBF4FD;
            --accent-glow: rgba(74, 158, 235, 0.15);
            --text-primary: #1A2332;
            --text-secondary: #6B7B8D;
            --text-label: #4A5568;
            --text-value: #4A9EEB;
            --success: #10B981;
            --success-bg: rgba(16, 185, 129, 0.08);
            --danger: #EF4444;
            --warning: #F59E0B;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.08);
            --font-sans: 'Inter', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition: 180ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            color-scheme: light;
        }

        body {
            background: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 13px;
            line-height: 1.6;
            min-height: 100vh;
            padding: 24px 16px;
        }

        /* â”€â”€ Layout â”€â”€ */
        .shell {
            max-width: 720px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 0 4px;
        }

        .header-left {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header .version {
            font-size: 11px;
            color: var(--accent);
            background: var(--accent-light);
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* â”€â”€ Collapsible Section â”€â”€ */
        .section {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition);
        }

        .section-header:hover {
            background: var(--bg-section);
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title .icon {
            font-size: 16px;
        }

        .section-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: transform 300ms ease;
            font-size: 12px;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-body {
            padding: 0 20px 20px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 300ms ease, padding 300ms ease, opacity 300ms ease;
            opacity: 1;
        }

        .section.collapsed .section-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        /* â”€â”€ Subsection â”€â”€ */
        .subsection {
            margin-bottom: 16px;
        }

        .subsection:last-child {
            margin-bottom: 0;
        }

        .sub-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 10px;
            padding-left: 2px;
        }

        /* â”€â”€ Field Row â”€â”€ */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
            background: var(--bg-section);
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            transition: border-color var(--transition);
        }

        .field:last-child {
            margin-bottom: 0;
        }

        .field:hover {
            border-color: var(--border);
        }

        .field-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .field-head label {
            font-size: 12px;
            color: var(--text-label);
            font-weight: 500;
        }

        .field-head .val {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-value);
            font-variant-numeric: tabular-nums;
            min-width: 36px;
            text-align: right;
        }

        .field-head .unit {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-left: 4px;
        }

        /* â”€â”€ Preset Select (3-option + text input) â”€â”€ */
        .preset-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .preset-btn {
            padding: 4px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-panel);
            color: var(--text-label);
            font-size: 12px;
            font-family: var(--font-sans);
            cursor: pointer;
            font-weight: 500;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .preset-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .preset-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* â”€â”€ Editable Preset Number â”€â”€ */
        .preset-num {
            width: 56px;
            padding: 4px 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: border-color var(--transition), background var(--transition), color var(--transition);
            -moz-appearance: textfield;
        }

        .preset-num::-webkit-inner-spin-button,
        .preset-num::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .preset-num:hover {
            border-color: var(--accent);
        }

        .preset-num:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-input-focus);
        }

        .preset-num.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .preset-input {
            flex: 1;
            min-width: 60px;
            padding: 4px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: var(--font-sans);
            font-variant-numeric: tabular-nums;
            outline: none;
            transition: border-color var(--transition);
        }

        .preset-input:focus {
            border-color: var(--accent);
        }

        /* â”€â”€ Range Slider â”€â”€ */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform var(--transition);
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid #fff;
            cursor: pointer;
        }

        /* â”€â”€ Text Input â”€â”€ */
        input[type=text],
        input[type=number] {
            width: 100%;
            padding: 7px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-family: var(--font-sans);
            font-variant-numeric: tabular-nums;
            outline: none;
            transition: border-color var(--transition);
        }

        input[type=text]:focus,
        input[type=number]:focus {
            border-color: var(--accent);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            opacity: 1;
        }

        /* â”€â”€ File Upload â”€â”€ */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition);
            background: var(--bg-section);
        }

        .file-upload-area:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .file-upload-area.has-file {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .file-upload-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .file-upload-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .file-upload-name {
            font-size: 13px;
            color: var(--success);
            font-weight: 600;
            margin-top: 4px;
        }

        /* â”€â”€ Data Association (read-only tree) â”€â”€ */
        .data-assoc {
            background: var(--bg-section);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-top: 10px;
            font-size: 12px;
            line-height: 1.8;
        }

        .data-assoc .assoc-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 13px;
        }

        .data-assoc .assoc-item {
            color: var(--text-label);
            padding-left: 12px;
        }

        .data-assoc .assoc-item::before {
            content: 'â€¢';
            margin-right: 6px;
            color: var(--accent);
        }

        .data-assoc .assoc-rule {
            color: var(--text-secondary);
            padding-left: 28px;
            font-size: 11px;
        }

        .data-assoc .assoc-rule::before {
            content: 'â†³';
            margin-right: 4px;
            color: var(--warning);
        }

        /* â”€â”€ Level Mode Radio â”€â”€ */
        .mode-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
        }

        .mode-tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--border);
            cursor: pointer;
            color: var(--text-label);
            background: var(--bg-section);
            transition: all var(--transition);
            font-family: var(--font-sans);
        }

        .mode-tab:first-child {
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .mode-tab:last-child {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .mode-tab.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        /* â”€â”€ Grade Table â”€â”€ */
        .grade-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .grade-table th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: left;
            padding: 8px 10px;
            border-bottom: 2px solid var(--border);
        }

        .grade-table td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--bg-section);
        }

        .grade-table .grade-level {
            font-weight: 700;
            color: var(--accent);
            font-size: 12px;
            white-space: nowrap;
            width: 38px;
        }

        .grade-table input[type=text],
        .grade-table input[type=number] {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* â”€â”€ Info text â”€â”€ */
        .info-text {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 6px 14px;
            line-height: 1.6;
        }

        /* read-only field */
        .readonly-field {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-section);
            padding: 10px 14px;
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .readonly-field .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        /* â”€â”€ Footer â”€â”€ */
        .footer {
            margin-top: 24px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-save {
            flex: 1;
            padding: 12px 24px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
        }

        .btn-save:hover {
            background: #3B8DD4;
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .btn-save:active {
            transform: scale(0.98);
        }

        .btn-reset {
            padding: 12px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: color var(--transition), border-color var(--transition);
        }

        .btn-reset:hover {
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn-download {
            padding: 12px 20px;
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-download:hover {
            background: var(--accent);
            color: #fff;
        }

        /* â”€â”€ Toast â”€â”€ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--success);
            padding: 10px 24px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: transform 300ms ease, opacity 300ms ease;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* â”€â”€ Separator â”€â”€ */
        .sep {
            height: 1px;
            background: var(--border);
            margin: 14px 0;
        }
    </style>
</head>

<body>
    <div class="shell">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>é…ç½®ä¸­å¿ƒ</h1>
                <span class="version">v2.0</span>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 1. ç‰©ç†å¼•æ“ â•â•â•â•â•â•â• -->
        <div class="section" id="sec-physics">
            <div class="section-header" onclick="toggleSection('sec-physics')">
                <div class="section-title"><span class="icon">âš™ï¸</span> ç‰©ç†å¼•æ“</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <!-- éšœç¢ç‰©ç¼©æ”¾ -->
                <div class="subsection">
                    <div class="sub-label">éšœç¢ç‰©ç¼©æ”¾</div>
                    <div class="field">
                        <div class="field-head">
                            <label>éšœç¢ç‰©è¿‘ç«¯å¤§å°</label>
                            <span class="val" data-for="physical_engine.obstacleScale.near">1.0</span>
                        </div>
                        <input type="range" id="physical_engine.obstacleScale.near" min="0.5" max="2.0" step="0.05"
                            value="1.0">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>éšœç¢ç‰©è¿œç«¯å¤§å°</label>
                            <span class="val" data-for="physical_engine.obstacleScale.far">0.15</span>
                        </div>
                        <input type="range" id="physical_engine.obstacleScale.far" min="0.05" max="0.5" step="0.01"
                            value="0.15">
                    </div>
                </div>

                <!-- ä»»åŠ¡é¡¹ç¼©æ”¾ -->
                <div class="subsection">
                    <div class="sub-label">ä»»åŠ¡é¡¹ç¼©æ”¾</div>
                    <div class="field">
                        <div class="field-head">
                            <label>ä»»åŠ¡é¡¹è¿‘ç«¯å¤§å°</label>
                            <span class="val" data-for="physical_engine.itemScale.near">0.9</span>
                        </div>
                        <input type="range" id="physical_engine.itemScale.near" min="0.5" max="2.0" step="0.05"
                            value="0.9">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>ä»»åŠ¡é¡¹è¿œç«¯å¤§å°</label>
                            <span class="val" data-for="physical_engine.itemScale.far">0.15</span>
                        </div>
                        <input type="range" id="physical_engine.itemScale.far" min="0.05" max="0.5" step="0.01"
                            value="0.15">
                    </div>
                </div>

                <!-- è¿åŠ¨å­¦å‚æ•° -->
                <div class="subsection">
                    <div class="sub-label">è¿åŠ¨å­¦å‚æ•°</div>
                    <div class="field">
                        <div class="field-head">
                            <label>è·³è·ƒå†²åŠ›<span class="unit">ï¼ˆæ•°å€¼ï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.jumpForce"
                                value="12" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.jumpForce"
                                value="15" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.jumpForce"
                                value="18" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>é‡åŠ›åŠ é€Ÿåº¦<span class="unit">ï¼ˆgï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.gravity"
                                step="0.1" value="0.6" onclick="selectEditablePreset(this)"
                                oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.gravity"
                                step="0.1" value="0.8" onclick="selectEditablePreset(this)"
                                oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="physical_engine.physics.gravity"
                                step="0.1" value="1.0" onclick="selectEditablePreset(this)"
                                oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 2. å•å…ƒå…³å¡è®¾ç½® â•â•â•â•â•â•â• -->
        <div class="section" id="sec-unit">
            <div class="section-header" onclick="toggleSection('sec-unit')">
                <div class="section-title"><span class="icon">ğŸ“š</span> å•å…ƒå…³å¡è®¾ç½®</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <!-- CSV ä¸Šä¼  -->
                <div class="subsection">
                    <div class="sub-label">å•å…ƒæ•°æ®æ¥æº</div>
                    <div class="file-upload-area" id="csv-upload-area"
                        onclick="document.getElementById('csv-file-input').click()">
                        <div class="file-upload-icon">ğŸ“„</div>
                        <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼  CSV æ–‡ä»¶</div>
                        <div class="file-upload-name" id="csv-file-name"></div>
                    </div>
                    <input type="file" id="csv-file-input" accept=".csv" style="display:none">
                </div>

                <!-- å•å…ƒä¿¡æ¯ -->
                <div class="subsection">
                    <div class="sub-label">å•å…ƒä¿¡æ¯</div>
                    <div class="field">
                        <input type="text" id="unit_settings.unitName" value="" placeholder="ä¸Šä¼ CSVåè‡ªåŠ¨å¡«å…¥æ–‡ä»¶åï¼Œå¯ä¿®æ”¹">
                    </div>
                </div>

                <!-- å…³å¡æ¨¡å¼ -->
                <div class="subsection">
                    <div class="sub-label">å•å…ƒå…³å¡è®¾ç½®</div>
                    <div class="mode-tabs">
                        <div class="mode-tab active" data-mode="soundToWord" onclick="switchMode(this)">éŸ³æ‰¾å­—</div>
                        <div class="mode-tab" data-mode="wordToSound" onclick="switchMode(this)">å­—æ‰¾éŸ³</div>
                    </div>

                    <!-- éŸ³æ‰¾å­— æ•°æ®å…³è” -->
                    <div class="data-assoc" id="assoc-soundToWord">
                        <div class="assoc-title">ã€ŒéŸ³æ‰¾å­—ã€æ•°æ®å…³è”è®¾ç½®</div>
                        <div class="assoc-item">ä»»åŠ¡åŒºæ•°æ®æ¥æºï¼š<strong>pinyin</strong></div>
                        <div class="assoc-item">æ­£ç¡®é¡¹æ•°æ®æ¥æºï¼š<strong>word</strong></div>
                        <div class="assoc-rule">æ­£ç¡®é¡¹è§„åˆ™1ï¼šåŒéŸ³å­—ä¸å¯åŒæ—¶å‡ºç°</div>
                        <div class="assoc-rule">æ­£ç¡®é¡¹è§„åˆ™2ï¼šå¤šéŸ³å­—åªè¯» pinyin ä¸­çš„è¯»éŸ³</div>
                        <div class="assoc-item">å¹²æ‰°é¡¹æ•°æ®æ¥æºï¼š<strong>word</strong></div>
                        <div class="assoc-rule">å¹²æ‰°é¡¹è§„åˆ™ï¼šæ’é™¤åŒéŸ³å­—</div>
                    </div>

                    <!-- å­—æ‰¾éŸ³ æ•°æ®å…³è” -->
                    <div class="data-assoc" id="assoc-wordToSound" style="display:none">
                        <div class="assoc-title">ã€Œå­—æ‰¾éŸ³ã€æ•°æ®å…³è”è®¾ç½®</div>
                        <div class="assoc-item">ä»»åŠ¡åŒºæ•°æ®æ¥æºï¼š<strong>word</strong></div>
                        <div class="assoc-item">æ­£ç¡®é¡¹æ•°æ®æ¥æºï¼š<strong>pinyin</strong></div>
                        <div class="assoc-rule">æ­£ç¡®é¡¹è§„åˆ™ï¼šå¤šéŸ³å­—åªè¯» pinyin ä¸­çš„è¯»éŸ³</div>
                        <div class="assoc-item">å¹²æ‰°é¡¹æ•°æ®æ¥æºï¼š<strong>pinyin</strong></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 3. å°å…³é€šå…³è®¾ç½® â•â•â•â•â•â•â• -->
        <div class="section" id="sec-level">
            <div class="section-header" onclick="toggleSection('sec-level')">
                <div class="section-title"><span class="icon">ğŸ</span> å°å…³é€šå…³è®¾ç½®</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <div class="subsection">
                    <div class="sub-label">é€šå…³æ¡ä»¶</div>
                    <div class="field">
                        <div class="field-head">
                            <label>é€šå…³æ—¶é—´<span class="unit">ï¼ˆç§’ï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="level_settings.goals.timeLimit"
                                value="30" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.timeLimit"
                                value="40" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.timeLimit"
                                value="50" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>ç´¯è®¡æ’å‡»æ­£ç¡®é¡¹<span class="unit">ï¼ˆä¸ªï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="level_settings.goals.targetCount"
                                value="6" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.targetCount"
                                value="8" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.targetCount"
                                value="10" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>è¿ç»­æ’å‡»æ­£ç¡®é¡¹<span class="unit">ï¼ˆä¸ªï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="level_settings.goals.comboTarget"
                                value="3" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.comboTarget"
                                value="4" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.goals.comboTarget"
                                value="5" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <div class="sub-label">å¤±è´¥æ¡ä»¶</div>
                    <div class="field">
                        <div class="field-head">
                            <label>ç´¯è®¡æ’å‡»é”™è¯¯é¡¹<span class="unit">ï¼ˆä¸ªï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="level_settings.fail.totalWrong"
                                value="5" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.fail.totalWrong"
                                value="6" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.fail.totalWrong"
                                value="7" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>è¿ç»­æ’å‡»é”™è¯¯é¡¹<span class="unit">ï¼ˆä¸ªï¼‰</span></label>
                        </div>
                        <div class="preset-group">
                            <input type="number" class="preset-num" data-target="level_settings.fail.comboWrong"
                                value="3" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.fail.comboWrong"
                                value="4" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                            <input type="number" class="preset-num" data-target="level_settings.fail.comboWrong"
                                value="5" onclick="selectEditablePreset(this)" oninput="selectEditablePreset(this)">
                        </div>
                    </div>
                    <div class="readonly-field">
                        <span class="dot"></span> ç”Ÿå‘½å€¼ä¸º0ï¼ˆä¸å¯è®¾ç½®ï¼‰
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 4. éš¾åº¦è®¾ç½® â•â•â•â•â•â•â• -->
        <div class="section" id="sec-difficulty">
            <div class="section-header" onclick="toggleSection('sec-difficulty')">
                <div class="section-title"><span class="icon">ğŸ“Š</span> éš¾åº¦è®¾ç½®</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <div class="subsection">
                    <div class="sub-label">ç”Ÿæˆå¯†åº¦</div>
                    <div class="field">
                        <div class="field-head">
                            <label>æ­£ç¡®é¡¹å¯†åº¦æ¦‚ç‡</label>
                            <span class="val" data-for="difficulty.spawn.targetDensity">0.6</span>
                        </div>
                        <input type="range" id="difficulty.spawn.targetDensity" min="0.1" max="1.0" step="0.05"
                            value="0.6">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>å¹²æ‰°é¡¹å¯†åº¦æ¦‚ç‡</label>
                            <span class="val" data-for="difficulty.spawn.distractorDensity">0.3</span>
                        </div>
                        <input type="range" id="difficulty.spawn.distractorDensity" min="0.1" max="1.0" step="0.05"
                            value="0.3">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>éšœç¢ç‰©å¯†åº¦æ¦‚ç‡</label>
                            <span class="val" data-for="difficulty.spawn.obstacleDensity">0.3</span>
                        </div>
                        <input type="range" id="difficulty.spawn.obstacleDensity" min="0.1" max="1.0" step="0.05"
                            value="0.3">
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 5. è®¡åˆ†ç³»ç»Ÿ â•â•â•â•â•â•â• -->
        <div class="section" id="sec-scoring">
            <div class="section-header" onclick="toggleSection('sec-scoring')">
                <div class="section-title"><span class="icon">ğŸ†</span> è®¡åˆ†ç³»ç»Ÿ</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <!-- åŸºç¡€å¾—åˆ† -->
                <div class="subsection">
                    <div class="sub-label">åŸºç¡€å¾—åˆ†</div>
                    <div class="field">
                        <div class="field-head">
                            <label>æ’å‡»æ­£ç¡®é¡¹å¾—åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label>
                        </div>
                        <input type="number" id="scoring.base.hitTarget" step="1" value="10">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>æ’å‡»å¹²æ‰°é¡¹æ‰£åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label>
                        </div>
                        <input type="number" id="scoring.base.hitDistractor" step="1" value="-3">
                    </div>
                    <div class="field">
                        <div class="field-head">
                            <label>æ’å‡»éšœç¢ç‰©<span class="unit">ï¼ˆåˆ†ï¼‰</span></label>
                        </div>
                        <input type="number" id="scoring.base.hitObstacle" step="1" value="-5">
                    </div>
                </div>

                <!-- è¿å‡»å¥–åŠ± -->
                <div class="subsection">
                    <div class="sub-label">è¿å‡»å¥–åŠ±</div>
                    <div class="field">
                        <div class="field-head"><label>2è¿å‡»åŠ åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label></div>
                        <input type="number" id="scoring.combo.combo2" step="5" value="20">
                    </div>
                    <div class="field">
                        <div class="field-head"><label>3è¿å‡»åŠ åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label></div>
                        <input type="number" id="scoring.combo.combo3" step="5" value="30">
                    </div>
                    <div class="field">
                        <div class="field-head"><label>4è¿å‡»åŠ åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label></div>
                        <input type="number" id="scoring.combo.combo4" step="5" value="40">
                    </div>
                    <div class="field">
                        <div class="field-head"><label>5è¿å‡»åŠ åˆ†<span class="unit">ï¼ˆåˆ†ï¼‰</span></label></div>
                        <input type="number" id="scoring.combo.combo5" step="5" value="50">
                    </div>
                    <p class="info-text">â€» å¥–åŠ±è®¡åˆ†ç»Ÿè®¡è§„åˆ™ï¼šè¿ç»­è¿å‡»å–æœ€åä¸€æ¬¡æœ€é«˜å¥–åŠ±</p>
                </div>

                <!-- ç”Ÿå‘½å€¼ -->
                <div class="subsection">
                    <div class="sub-label">ç”Ÿå‘½å€¼</div>
                    <div class="field">
                        <div class="field-head"><label>åˆå§‹ç”Ÿå‘½å€¼<span class="unit">ï¼ˆæ¡ï¼‰</span></label></div>
                        <input type="number" id="scoring.lives.initLives" step="1" min="1" value="3">
                    </div>
                    <div class="field">
                        <div class="field-head"><label>æ’å‡»å¹²æ‰°é¡¹æ‰£ç”Ÿå‘½<span class="unit">ï¼ˆæ¡ï¼‰</span></label></div>
                        <input type="number" id="scoring.lives.distractorDamage" step="0.5" min="0" value="0.5">
                    </div>
                    <div class="field">
                        <div class="field-head"><label>æ’å‡»éšœç¢ç‰©æ‰£ç”Ÿå‘½<span class="unit">ï¼ˆæ¡ï¼‰</span></label></div>
                        <input type="number" id="scoring.lives.obstacleDamage" step="0.5" min="0" value="1">
                    </div>
                </div>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â• 6. è§’è‰²è®¾ç½® â•â•â•â•â•â•â• -->
        <div class="section" id="sec-character">
            <div class="section-header" onclick="toggleSection('sec-character')">
                <div class="section-title"><span class="icon">ğŸ‘¤</span> è§’è‰²è®¾ç½®</div>
                <div class="section-toggle">â–¼</div>
            </div>
            <div class="section-body">
                <div class="subsection">
                    <div class="sub-label">è§’è‰²æ˜µç§°</div>
                    <div class="field">
                        <input type="text" id="character.nickname" value="è´è´">
                    </div>
                </div>

                <div class="subsection">
                    <div class="sub-label">è§’è‰²ç­‰çº§</div>
                    <table class="grade-table">
                        <thead>
                            <tr>
                                <th>ç­‰çº§</th>
                                <th>åç§°</th>
                                <th>æ¡ä»¶ï¼ˆåˆ†ï¼‰</th>
                            </tr>
                        </thead>
                        <tbody id="grade-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <button class="btn-save" id="btn-save">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="btn-download" id="btn-download">ğŸ“¥ ä¸‹è½½åˆ†äº«</button>
            <button class="btn-reset" id="btn-reset">æ¢å¤é»˜è®¤</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">âœ“ é…ç½®å·²ä¿å­˜è‡³æœ¬åœ°å­˜å‚¨</div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  è§’è‰²ç­‰çº§é»˜è®¤æ•°æ®
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const GRADE_DEFAULTS = [
            { level: 'V1', name: 'ç«¥ç”Ÿ', score: 100 },
            { level: 'V2', name: 'ç§€æ‰', score: 200 },
            { level: 'V3', name: 'è´¡ç”Ÿ', score: 300 },
            { level: 'V4', name: 'ä¸¾äºº', score: 400 },
            { level: 'V5', name: 'è§£å…ƒ', score: 500 },
            { level: 'V6', name: 'è´¡å£«', score: 600 },
            { level: 'V7', name: 'ä¼šå…ƒ', score: 700 },
            { level: 'V8', name: 'è¿›å£«', score: 800 },
            { level: 'V9', name: 'æ¢èŠ±', score: 900 },
            { level: 'V10', name: 'æ¦œçœ¼', score: 1000 },
            { level: 'V11', name: 'çŠ¶å…ƒ', score: 1100 }
        ];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  CFG é»˜è®¤å€¼
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const DEFAULTS = {
            physical_engine: {
                trackWidth: 1.0,
                obstacleScale: { near: 1.0, far: 0.15 },
                itemScale: { near: 0.9, far: 0.15 },
                physics: { jumpForce: 15, gravity: 0.8 }
            },
            unit_settings: {
                unitName: '',
                csvData: null,
                mode: 'soundToWord'
            },
            level_settings: {
                goals: { timeLimit: 40, targetCount: 8, comboTarget: 3 },
                fail: { totalWrong: 5, comboWrong: 3 }
            },
            difficulty: {
                spawn: { targetDensity: 0.6, distractorDensity: 0.3, obstacleDensity: 0.3 }
            },
            scoring: {
                base: { hitTarget: 10, hitDistractor: -3, hitObstacle: -5 },
                combo: { combo2: 20, combo3: 30, combo4: 40, combo5: 50 },
                lives: { initLives: 3, distractorDamage: 0.5, obstacleDamage: 1.0 }
            },
            character: {
                nickname: 'è´è´',
                grades: JSON.parse(JSON.stringify(GRADE_DEFAULTS))
            },
            dataSource: {
                offlineData: []
            }
        };

        const CFG = JSON.parse(JSON.stringify(DEFAULTS));

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Utility functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getByPath(obj, path) {
            return path.split('.').reduce((o, k) => o && o[k], obj);
        }
        function setByPath(obj, path, val) {
            const keys = path.split('.');
            let cur = obj;
            for (let i = 0; i < keys.length - 1; i++) {
                if (!(keys[i] in cur)) cur[keys[i]] = {};
                cur = cur[keys[i]];
            }
            cur[keys[keys.length - 1]] = val;
        }
        function deepMerge(target, source) {
            for (const key of Object.keys(source)) {
                if (source[key] && typeof source[key] === 'object' &&
                    !Array.isArray(source[key]) && target[key] && typeof target[key] === 'object') {
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Collapsible sections
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function toggleSection(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Preset select (3-option + text)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setPreset(path, value, btnEl) {
            const input = document.getElementById(path);
            if (input) input.value = value;
            // highlight active btn
            const group = btnEl.parentElement;
            group.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');
            // sync to CFG
            setByPath(CFG, path, value);
        }

        // Editable preset number: click to select, edit value in-place
        function selectEditablePreset(el) {
            const path = el.dataset.target;
            const val = parseFloat(el.value);
            if (isNaN(val)) return;

            // 1. highlight active in THIS group
            const group = el.parentElement;
            group.querySelectorAll('.preset-num').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            // 2. update CFG object
            setByPath(CFG, path, val);

            // 3. (Optional) Sync other inputs if they exist (unlikely now)
            const input = document.getElementById(path);
            if (input) input.value = val;
        }

        // Sync editable preset highlight when value matches
        function syncEditablePresetHighlight(path) {
            const val = getByPath(CFG, path);
            document.querySelectorAll(`.preset-num[data-target="${path}"]`).forEach(num => {
                num.classList.toggle('active', parseFloat(num.value) == val);
            });
        }

        // Bind change events to all editable preset numbers
        document.querySelectorAll('.preset-num').forEach(num => {
            num.addEventListener('change', () => {
                // When user edits the value and presses enter or blurs, just update the value
                // but do NOT auto-select â€” user needs to click to select
            });
            // Prevent click default from selecting text inside, keep focus for editing
            num.addEventListener('focus', (e) => e.target.select());
        });

        function syncPresetHighlight(inputEl) {
            const group = inputEl.parentElement;
            const val = inputEl.value.trim();
            group.querySelectorAll('.preset-btn').forEach(b => {
                b.classList.toggle('active', b.textContent.trim() === val);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Mode tabs (éŸ³æ‰¾å­— / å­—æ‰¾éŸ³)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchMode(el) {
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            const mode = el.dataset.mode;
            CFG.unit_settings.mode = mode;
            document.getElementById('assoc-soundToWord').style.display = mode === 'soundToWord' ? '' : 'none';
            document.getElementById('assoc-wordToSound').style.display = mode === 'wordToSound' ? '' : 'none';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  CSV upload
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('csv-file-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const area = document.getElementById('csv-upload-area');
            const nameEl = document.getElementById('csv-file-name');
            const unitNameInput = document.getElementById('unit_settings.unitName');

            const reader = new FileReader();
            reader.onload = function (ev) {
                const text = ev.target.result;
                const lines = text.trim().split(/\r?\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    const row = {};
                    headers.forEach((h, idx) => row[h] = (cols[idx] || '').trim());
                    data.push(row);
                }
                CFG.unit_settings.csvData = data;

                // Update UI
                const baseName = file.name.replace(/\.csv$/i, '');
                area.classList.add('has-file');
                nameEl.textContent = 'âœ“ ' + file.name + 'ï¼ˆ' + data.length + ' æ¡æ•°æ®ï¼‰';

                // è‡ªåŠ¨å¡«å…¥å¹¶æ›´æ–°å•å…ƒåç§°
                unitNameInput.value = baseName;
                CFG.unit_settings.unitName = baseName;
            };
            reader.readAsText(file);
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Grade table rendering
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderGradeTable() {
            const tbody = document.getElementById('grade-tbody');
            const grades = CFG.character.grades;
            tbody.innerHTML = '';
            grades.forEach((g, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="grade-level">${g.level}</td>
                    <td><input type="text" data-grade-idx="${i}" data-grade-field="name" value="${g.name}" style="width:80px"></td>
                    <td><input type="number" data-grade-idx="${i}" data-grade-field="score" value="${g.score}" style="width:80px"></td>
                `;
                tbody.appendChild(tr);
            });
            // Bind events
            tbody.querySelectorAll('input').forEach(inp => {
                inp.addEventListener('input', () => {
                    const idx = parseInt(inp.dataset.gradeIdx);
                    const field = inp.dataset.gradeField;
                    if (field === 'score') {
                        CFG.character.grades[idx].score = parseFloat(inp.value) || 0;
                    } else {
                        CFG.character.grades[idx].name = inp.value;
                    }
                });
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Two-way binding
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Collect bindable inputs (exclude grade-table and csv)
        function getBindableInputs() {
            return document.querySelectorAll(
                'input[id]:not([type=file]):not([data-grade-idx]), select[id]'
            );
        }

        function cfgToUI() {
            getBindableInputs().forEach(el => {
                const path = el.id;
                const val = getByPath(CFG, path);
                if (val === undefined) return;
                if (el.type === 'checkbox') {
                    el.checked = !!val;
                } else if (el.type === 'range') {
                    el.value = val;
                    const span = document.querySelector(`.val[data-for="${path}"]`);
                    if (span) span.textContent = val;
                } else {
                    el.value = val;
                }
            });

            // sync editable preset nums
            const presetPaths = [
                'physical_engine.physics.jumpForce', 'physical_engine.physics.gravity',
                'level_settings.goals.timeLimit', 'level_settings.goals.targetCount', 'level_settings.goals.comboTarget',
                'level_settings.fail.totalWrong', 'level_settings.fail.comboWrong'
            ];
            presetPaths.forEach(syncEditablePresetHighlight);

            // mode tabs
            document.querySelectorAll('.mode-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.mode === CFG.unit_settings.mode);
            });
            document.getElementById('assoc-soundToWord').style.display =
                CFG.unit_settings.mode === 'soundToWord' ? '' : 'none';
            document.getElementById('assoc-wordToSound').style.display =
                CFG.unit_settings.mode === 'wordToSound' ? '' : 'none';

            renderGradeTable();
        }

        function uiToCFG() {
            // 1. Handle standard inputs (with IDs)
            getBindableInputs().forEach(el => {
                const path = el.id;
                let val;
                if (el.type === 'checkbox') {
                    val = el.checked;
                } else if (el.type === 'range' || el.type === 'number') {
                    val = parseFloat(el.value);
                } else if (el.tagName === 'SELECT') {
                    val = isNaN(el.value) ? el.value : parseFloat(el.value);
                } else {
                    val = el.value;
                }
                setByPath(CFG, path, val);
            });

            // 2. Handle group presets (Winning conditions, Kinematics etc)
            document.querySelectorAll('.preset-group').forEach(group => {
                const activeNum = group.querySelector('.preset-num.active');
                if (activeNum) {
                    const path = activeNum.dataset.target;
                    const val = parseFloat(activeNum.value);
                    if (!isNaN(val)) setByPath(CFG, path, val);
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Live binding events
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.querySelectorAll('input[type=range]').forEach(slider => {
            slider.addEventListener('input', () => {
                const span = document.querySelector(`.val[data-for="${slider.id}"]`);
                if (span) span.textContent = slider.value;
                setByPath(CFG, slider.id, parseFloat(slider.value));
            });
        });
        document.querySelectorAll('input[type=number]').forEach(inp => {
            if (inp.dataset.gradeIdx !== undefined) return;
            inp.addEventListener('input', () => {
                if (inp.id) setByPath(CFG, inp.id, parseFloat(inp.value));
            });
        });
        document.querySelectorAll('.preset-input').forEach(inp => {
            inp.addEventListener('input', () => {
                syncPresetHighlight(inp);
                const num = parseFloat(inp.value);
                setByPath(CFG, inp.id, isNaN(num) ? inp.value : num);
            });
        });
        document.querySelectorAll('input[type=text]').forEach(inp => {
            if (inp.classList.contains('preset-input')) return;
            if (inp.dataset.gradeIdx !== undefined) return;
            inp.addEventListener('input', () => {
                if (inp.id) setByPath(CFG, inp.id, inp.value);
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Save / Load / Reset
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function save() {
            uiToCFG();
            localStorage.setItem('WRM_UserConfig', JSON.stringify(CFG));
            showToast('âœ“ é…ç½®å·²ä¿å­˜è‡³æœ¬åœ°å­˜å‚¨');
        }

        function load() {
            try {
                const raw = localStorage.getItem('WRM_UserConfig');
                if (!raw) return;
                const saved = JSON.parse(raw);
                deepMerge(CFG, saved);
                // Restore grades array if present
                if (saved.character && Array.isArray(saved.character.grades)) {
                    CFG.character.grades = saved.character.grades;
                }
            } catch (e) {
                console.warn('åŠ è½½é…ç½®å¤±è´¥:', e);
            }
        }

        function resetToDefaults() {
            const fresh = JSON.parse(JSON.stringify(DEFAULTS));
            Object.keys(fresh).forEach(k => CFG[k] = fresh[k]);
            cfgToUI();
            showToast('âœ“ å·²æ¢å¤é»˜è®¤é…ç½®');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (msg) t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Download / Share
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Download / Share (Standalone Game Export) - v3.5.0
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function downloadShare() {
            uiToCFG();

            // 1. æ ¸å¿ƒéœ€æ±‚ï¼šå…¨é‡å¯¼å‡ºæ•°æ® (å¼ºåˆ¶å°† CSV è§£æç»“æœå›ºåŒ–åˆ° CFG)
            if (CFG.unit_settings && Array.isArray(CFG.unit_settings.csvData)) {
                CFG.dataSource = CFG.dataSource || {};
                CFG.dataSource.offlineData = CFG.unit_settings.csvData.map(d => ({
                    word: d.word || '',
                    pinyin: d.pinyin || '',
                    radical: d.radical || '',
                    words_std: d.words_std || ''
                }));
                console.log('âœ… å·²å…¨é‡å›ºåŒ–ç¦»çº¿æ•°æ®:', CFG.dataSource.offlineData.length, 'æ¡');
            }

            // 2. æ–‡ä»¶åå®‰å…¨è¿‡æ»¤ (Sanitize filename)
            const rawName = CFG.unit_settings.unitName || 'å•å…ƒä¿¡æ¯';
            const safeName = rawName.replace(/[\\/:\*\?"<>\|]/g, '_').trim(); // åŸºç¡€è¿‡æ»¤
            const fileName = `${safeName}.html`;
            const cfgJson = JSON.stringify(CFG, null, 2);

            try {
                // è·å–æ¸¸æˆæ¨¡æ¿
                let template = '';
                try {
                    const resp = await fetch('index.html');
                    if (resp.ok) {
                        template = await resp.text();
                    } else { throw new Error('Fetch failed'); }
                } catch (e) {
                    alert('âŒ ä¸‹è½½å¤±è´¥ï¼šæ— æ³•è·å– index.htmlã€‚è¯·åœ¨æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒè¿è¡Œæœ¬é¡µé¢ã€‚');
                    return;
                }

                // 3. å³æ—¶è‡ªæ„ˆé€»è¾‘æ³¨å…¥ (window.OFFLINE_CONFIG)
                // åœ¨ head é¡¶éƒ¨æ³¨å…¥ï¼Œç¡®ä¿æ¯”ä»»ä½•å¼•æ“é€»è¾‘éƒ½å…ˆè¿è¡Œ
                const injection = `
    <!-- Standalone Force Offline Config (v4.6) -->
    <script>
        window.OFFLINE_CONFIG = ${cfgJson};
        // å¼ºåˆ¶åˆå§‹åŒ–è‡ªæ„ˆ (è§£å†³ File åè®® localStorage å—é™é—®é¢˜)
        try {
            localStorage.setItem('WRM_UserConfig', JSON.stringify(window.OFFLINE_CONFIG));
        } catch(e) { console.warn("LocalStorage access denied in File protocol mode."); }
    <\/script>
                `;

                // æ³¨å…¥åˆ° </head> ä¹‹å‰
                let finalHtml = template.replace('</head>', injection + '\n</head>');

                // 4. (å·²ç§»é™¤åŒé‡ä¿éšœï¼šä¿ç•™ index.html åŸç”Ÿ WRM_CONFIGï¼Œç”± loadConfig è¿›è¡Œå®‰å…¨åˆå¹¶)
                // è¿™ä¿®å¤äº†å¯¼å‡ºåå› ç¼ºå°‘åŸºç¡€å­—æ®µ (å¦‚ rules, physics) å¯¼è‡´ ST å¯¹è±¡åˆå§‹åŒ–å´©æºƒçš„é—®é¢˜

                // åŒæ­¥æ ‡é¢˜
                finalHtml = finalHtml.replace(/<title>.*?<\/title>/, `<title>${safeName} - å­—è·‘å¤§å¸ˆ</title>`);

                // 5. è§¦å‘ç‰©ç†ä¸‹è½½
                const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = fileName;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast(`ğŸ“¥ ${fileName} å¯¼å‡ºæˆåŠŸ`);
            } catch (err) {
                console.error(err);
                showToast('âŒ å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Events
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('btn-save').addEventListener('click', save);
        document.getElementById('btn-reset').addEventListener('click', resetToDefaults);
        document.getElementById('btn-download').addEventListener('click', downloadShare);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  Init
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        load();
        cfgToUI();
    </script>
</body>

</html>